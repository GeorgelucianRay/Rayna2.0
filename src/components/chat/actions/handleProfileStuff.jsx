// src/components/chat/actions/handleProfileStuff.jsx
import React from "react";
import styles from "../Chatbot.module.css";
// ‚¨ÜÔ∏è la √Ænceputul fi»ôierului, l√¢ngƒÉ celelalte importuri:
import { supabase } from "../../../supabaseClient";

export async function handleProfileAdvantagesVideo({ setMessages }) {
  const NEEDLES = [
    // ES
    "perfil completado", "perfil completo", "ventajas perfil",
    "por qu√© completar el perfil", "completar perfil",
    // RO / CA ‚Äì ca √Æn lista ta din screenshot
    "profil completat", "perfil completat"
  ];

  const orFilter = NEEDLES.map(t => `title.ilike.%${t}%`).join(",");

  let url = null;
  try {
    const { data, error } = await supabase
      .from("aprender_links")
      .select("id,title,url")
      .or(orFilter)
      .order("title", { ascending: true })
      .limit(1);

    if (!error && data?.length) url = data[0].url;
  } catch { /* ignorƒÉm; avem fallback */ }

  if (!url) {
    // fallback: oferƒÉ card cƒÉtre /aprender (nu dƒÉ 404 dacƒÉ ruta existƒÉ / user logat)
    setMessages(m => [
      ...m,
      {
        from: "bot",
        reply_text:
          "A√∫n no tengo guardado el v√≠deo con ese t√≠tulo. Te llevo a ¬´Aprender¬ª por si te sirve."
      },
      {
        from: "bot",
        reply_text: "Abre la secci√≥n de aprendizaje:",
        render: () => (
          <div className={styles.card}>
            <div className={styles.cardTitle}>Aprender</div>
            <div className={styles.cardActions}>
              <a className={styles.actionBtn} data-variant="primary" href="/aprender">
                Abrir Aprender
              </a>
            </div>
          </div>
        )
      }
    ]);
    return;
  }

  // URL gƒÉsit √Æn Supabase ‚Üí buton extern direct la video
  setMessages(m => [
    ...m,
    {
      from: "bot",
      reply_text:
        "Mira, te he preparado un v√≠deo sobre la importancia de completar el perfil y c√≥mo hacerlo.",
      render: () => (
        <div className={styles.card}>
          <div className={styles.cardTitle}>Ventajas de completar el perfil</div>
          <div className={styles.cardActions}>
            <a
              className={styles.actionBtn}
              data-variant="primary"
              href={url}
              target="_blank"
              rel="noopener noreferrer"
            >
              Ver v√≠deo
            </a>
          </div>
        </div>
      )
    }
  ]);
}

/* ‚Äî‚Äî‚Äî util: traduce rolul intern la ES ‚Äî‚Äî‚Äî */
function roleToEs(role = "") {
  const r = String(role).toLowerCase().trim();
  if (r === "sofer" || r === "≈üofer" || r === "»ôofer" || r === "driver") return "chofer";
  if (r === "dispecer" || r === "dispatcher") return "Jefe de Tr√°fico";
  if (r === "mecanic" || r === "mechanic") return "mec√°nico";
  return r || "chofer";
}

/* ‚Äî‚Äî‚Äî QUI√âN SOY ‚Äî‚Äî‚Äî */
export async function handleWhoAmI({ profile, setMessages, setAwaiting }) {
  // folosim utilul tƒÉu existent:
  const nombre = profile?.nombre_completo || profile?.username || "usuario";
  const rolEs  = roleToEs(profile?.role);

  const truck  = profile?.camioane || profile?.truck || null;
  const marca  = truck?.marca || truck?.brand || "";
  const plate  = truck?.matricula || truck?.plate || "";
  const extra  = (marca || plate)
    ? ` Llevas un cami√≥n ${[marca, plate].filter(Boolean).join(" ¬∑ ")}.`
    : "";

  setMessages((m) => [
  ...m,
  {
    from: "bot",
    reply_text: `T√∫ eres ${nombre} (${rolEs}).${extra} ¬øQuieres ver tu perfil?`
  }
]);

  // üî∏ a≈üteptƒÉm confirmarea userului
  setAwaiting("confirm_view_profile");
}

/* ‚Äî‚Äî‚Äî ABRIR MI CAMI√ìN ‚Äî‚Äî‚Äî */
export async function handleOpenMyTruck({ profile, setMessages }) {
  const truckId   = profile?.camion_id || profile?.camioane?.id || profile?.truck?.id;
  const truck     = profile?.camioane || profile?.truck || {};
  const marca     = truck?.marca || truck?.brand || "Cami√≥n";
  const matricula = truck?.matricula || truck?.plate || "";

  if (!truckId) {
    setMessages(m => [
      ...m,
      { from: "bot", reply_text: "No tienes un cami√≥n asignado por ahora." },
      {
        from: "bot",
        reply_text: "Puedes revisar o actualizar tus datos desde tu perfil.",
        render: () => (
          <div className={styles.card}>
            <div className={styles.cardTitle}>Perfil</div>
            <div className={styles.cardActions}>
              <a className={styles.actionBtn} data-variant="primary" href="/mi-perfil">Ver perfil</a>
            </div>
          </div>
        )
      }
    ]);
    return;
  }

  setMessages(m => [
    ...m,
    {
      from: "bot",
      reply_text: `Claro, aqu√≠ tienes la ficha del cami√≥n ${marca}${matricula ? " ¬∑ " + matricula : ""}.`,
      render: () => (
        <div className={styles.card}>
          <div className={styles.cardTitle}>Mi cami√≥n</div>
          <div className={styles.cardActions}>
            <a className={styles.actionBtn} data-variant="primary" href={`/camion/${truckId}`}>
              Ver cami√≥n
            </a>
          </div>
        </div>
      )
    }
  ]);
}

/* ‚Äî‚Äî‚Äî SELF INFO (CAP/ADR/licencia/ITV r√°pidas cu meta.topic) ‚Äî‚Äî‚Äî */
export async function handleDriverSelfInfo({ profile, intent, setMessages }) {
  const topic = intent?.meta?.topic;

  if (topic === "truck_itv") {
    const itv = profile?.camioane?.itv || profile?.truck?.itv || "‚Äî";
    setMessages(m => [...m, { from: "bot", reply_text: `La ITV de tu cami√≥n es **${itv}**.` }]);
    return;
  }
  if (topic === "trailer_itv") {
    const itv = profile?.remolque?.itv || profile?.trailer?.itv || "‚Äî";
    setMessages(m => [...m, { from: "bot", reply_text: `La ITV de tu remolque es **${itv}**.` }]);
    return;
  }
  if (topic === "driver_credentials") {
    const cap = profile?.driver?.cap || "‚Äî";
    const lic = profile?.driver?.lic || "‚Äî";
    const adr = profile?.driver?.adr || "‚Äî";
    setMessages(m => [...m, { from: "bot", reply_text: `CAP: **${cap}** ¬∑ Carnet: **${lic}** ¬∑ ADR: **${adr}**` }]);
    return;
  }

  setMessages(m => [...m, { from: "bot", reply_text: "No tengo a√∫n ese dato en tu perfil." }]);
}

/* ‚Äî‚Äî‚Äî VEH√çCULO: ITV / ACEITE / ADBLUE ‚Äî‚Äî‚Äî */
export async function handleVehItvTruck({ profile, setMessages }) {
  const itv = profile?.camioane?.itv || profile?.truck?.itv || "‚Äî";
  setMessages(m => [...m, { from: "bot", reply_text: `ITV cami√≥n: **${itv}**.` }]);
}

export async function handleVehItvTrailer({ profile, setMessages }) {
  const itv = profile?.remolque?.itv || profile?.trailer?.itv || "‚Äî";
  setMessages(m => [...m, { from: "bot", reply_text: `ITV remolque: **${itv}**.` }]);
}

export async function handleVehOilStatus({ profile, setMessages }) {
  const last = profile?.mantenimientos?.aceite?.ultimo || "‚Äî";
  const next = profile?.mantenimientos?.aceite?.proximo || "‚Äî";
  setMessages(m => [...m, { from: "bot", reply_text: `Aceite ‚Äî √∫ltimo: **${last}** ¬∑ pr√≥ximo: **${next}**.` }]);
}

export async function handleVehAdblueFilterStatus({ profile, setMessages }) {
  const last = profile?.mantenimientos?.adblue?.ultimo || "‚Äî";
  const next = profile?.mantenimientos?.adblue?.proximo || "‚Äî";
  setMessages(m => [...m, { from: "bot", reply_text: `Filtro AdBlue ‚Äî √∫ltimo: **${last}** ¬∑ pr√≥ximo: **${next}**.` }]);
}

/* ‚Äî‚Äî‚Äî INI»öIERE COMPLETARE PROFIL ‚Äî‚Äî‚Äî */
export async function handleProfileCompletionStart({ setMessages }) {
  setMessages(m => [
    ...m,
    { from: "bot", reply_text: "Perfecto. Te llevo al formulario para completar tu perfil." },
    {
      from: "bot",
      reply_text: "Pulsa el bot√≥n para abrir tu perfil.",
      render: () => (
        <div className={styles.card}>
          <div className={styles.cardTitle}>Perfil</div>
          <div className={styles.cardActions}>
            <a className={styles.actionBtn} data-variant="primary" href="/mi-perfil">Editar perfil</a>
          </div>
        </div>
      )
    }
  ]);
}
export async function handleWhatDoYouKnowAboutMe({ profile, setMessages, setAwaiting }) {
  const nombre = profile?.nombre_completo || profile?.username || "usuario";
  const rolEs  = (function roleToEs(role = "") {
    const r = String(role).toLowerCase().trim();
    if (["sofer","≈üofer","»ôofer","driver"].includes(r)) return "chofer";
    if (["dispecer","dispatcher"].includes(r)) return "Jefe de Tr√°fico";
    if (["mecanic","mechanic"].includes(r)) return "mec√°nico";
    return r || "chofer";
  })(profile?.role);

  // date profil
  const drv = profile?.driver || {};
  const truck = profile?.camioane || profile?.truck || {};
  const trailer = profile?.remolque || profile?.trailer || {};

  // bullets dinamice
  const bullets = [];

  bullets.push(`‚Ä¢ Te llamas **${nombre}** (${rolEs}).`);

  if (drv?.adr != null) {
    bullets.push(`‚Ä¢ ADR: **${drv.adr ? "s√≠" : "no"}**.`);
  }
  if (drv?.lic) {
    bullets.push(`‚Ä¢ Carnet: **${drv.lic}**.`);
  }
  if (drv?.cap) {
    bullets.push(`‚Ä¢ CAP: **${drv.cap}**.`);
  }

  if (truck?.marca || truck?.brand || truck?.matricula || truck?.plate) {
    const tMarca = truck?.marca || truck?.brand || "Cami√≥n";
    const tPlaca = truck?.matricula || truck?.plate || "";
    bullets.push(`‚Ä¢ Cami√≥n: **${tMarca}${tPlaca ? " ¬∑ " + tPlaca : ""}**.`);
  }
  if (trailer?.marca || trailer?.brand || trailer?.matricula || trailer?.plate) {
    const rMarca = trailer?.marca || trailer?.brand || "Remolque";
    const rPlaca = trailer?.matricula || trailer?.plate || "";
    bullets.push(`‚Ä¢ Remolque: **${rMarca}${rPlaca ? " ¬∑ " + rPlaca : ""}**.`);
  }

  const hasCore =
    (drv?.adr != null) || drv?.lic || drv?.cap ||
    truck?.marca || truck?.brand || truck?.matricula || truck?.plate ||
    trailer?.marca || trailer?.brand || trailer?.matricula || trailer?.plate;

  if (hasCore) {
    // ‚úÖ Avem informa»õii ‚Äî le arƒÉtƒÉm
    setMessages(m => [
      ...m,
      { from: "bot", reply_text: "Esto es lo que s√© de ti:" },
      { from: "bot", reply_text: bullets.join("\n") },
    ]);
    return;
  }

  // ‚ùå Nu avem (aproape) nimic √Æn profil
  setMessages(m => [
    ...m,
    { from: "bot", reply_text: "De momento solo s√© c√≥mo te llamas, pero puedes contarme m√°s completando tu perfil. ¬øQuieres que te ayude?" }
  ]);

  // intrƒÉm √Æn a»ôteptare pt. confirmare (s√≠/no)
  setAwaiting && setAwaiting("confirm_complete_profile");
}

/* op»õional: handler pentru buton/video ‚ÄûAprender: Perfil completado‚Äù */
export async function handleShowAprenderPerfil({ setMessages }) {
  setMessages(m => [
    ...m,
    { from: "bot", reply_text: "Mira, te he preparado un v√≠deo sobre la importancia de completar el perfil y c√≥mo hacerlo." },
    {
      from: "bot",
      reply_text: "Pulsa el bot√≥n para verlo.",
      render: () => (
        <div className={styles.card}>
          <div className={styles.cardTitle}>Aprender</div>
          <div className={styles.cardActions}>
            {/* dacƒÉ ai un slug/filtru, schimbƒÉ la /aprender?slug=perfil-completado */}
            <a className={styles.actionBtn} data-variant="primary" href="/aprender" target="_blank" rel="noopener noreferrer">
              Aprender: Perfil completado
            </a>
          </div>
        </div>
      ),
    },
  ]);
}